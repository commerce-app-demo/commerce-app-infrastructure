name: Terraform Apply Google Artifact Registry
on:
  push:
    branches: [ main ]

jobs:
    apply-artifact-registry:
      permissions: 
        actions: read
        contents: read
      runs-on: ubuntu-latest
      env: 
        tf_actions_working_dir: ./modules/google-artifact-registry
      steps:
        - name: Get PR head commit
          id: pr_head
          run: |
            PR_HEAD_SHA=$(git rev-parse HEAD~1)
            echo "sha=$PR_HEAD_SHA" >> $GITHUB_OUTPUT

        - name: Checkout code
          uses: actions/checkout@v4
        
        - name: Set up Terraform
          uses: hashicorp/setup-terraform@v3
          with:
            terraform_version: 1.6.0
            
        - name: Auth
          uses: google-github-actions/auth@v2
          with: 
            credentials_json: ${{ secrets.GOOGLE_CREDENTIALS }}

        - name: Download plan
          uses: actions/download-artifact@v4
          with:
            name: terraform-plan-${{ steps.pr_head.outputs.sha }}
        
        - name: Terraform apply
          working-directory: ${{ env.tf_actions_working_dir }}
          run: terraform apply tfplan
